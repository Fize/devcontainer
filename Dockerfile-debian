FROM debian:rc-buggy

ARG GO_VERSION=1.25.3
ARG PY_VERSION=3.13.1
ARG NODE_VERSION=24.12.0

ENV DEBIAN_FRONTEND=noninteractive \
    GO_VERSION=${GO_VERSION} \
    PY_VERSION=${PY_VERSION} \
    NODE_VERSION=${NODE_VERSION} \
    PATH=/usr/local/go/bin:/usr/local/node/bin:$PATH

# Python 多阶段构建
FROM debian:rc-buggy AS python-builder
ARG PY_VERSION=3.13.1
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential libssl-dev zlib1g-dev libncurses5-dev \
    libncursesw5-dev libreadline-dev libsqlite3-dev libgdbm-dev \
    libdb5.3-dev libbz2-dev libexpat1-dev libffi-dev \
    ca-certificates curl \
    && curl -fsSL https://www.python.org/ftp/python/${PY_VERSION}/Python-${PY_VERSION}.tgz -o Python-${PY_VERSION}.tgz \
    && curl -fsSL https://www.python.org/ftp/python/${PY_VERSION}/Python-${PY_VERSION}.tgz.asc -o Python-${PY_VERSION}.tgz.asc \
    && gpg --batch --quiet --keyserver hkps://keys.openpgp.org --recv-keys 7169605F62C751356D394A68EDC8423E7D74467 \
    && gpg --batch --quiet --verify Python-${PY_VERSION}.tgz.asc Python-${PY_VERSION}.tgz \
    && tar -xzf Python-${PY_VERSION}.tgz \
    && cd Python-${PY_VERSION} \
    && ./configure --enable-optimizations \
    && make -j$(nproc) \
    && make altinstall \
    && cd / \
    && rm -rf Python-${PY_VERSION} Python-${PY_VERSION}.tgz Python-${PY_VERSION}.tgz.asc \
    && apt-get purge -y --auto-remove build-essential curl gpg \
    && rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/* /tmp/*

FROM debian:rc-buggy
ARG GO_VERSION=1.25.3
ARG PY_VERSION=3.13.1
ARG NODE_VERSION=24.12.0

ENV DEBIAN_FRONTEND=noninteractive \
    GO_VERSION=${GO_VERSION} \
    PY_VERSION=${PY_VERSION} \
    NODE_VERSION=${NODE_VERSION} \
    PATH=/usr/local/go/bin:/usr/local/node/bin:/usr/local/bin:$PATH

# 安装基础工具与编译环境（不含 Python）
RUN apt-get update && apt-get upgrade -y --no-install-recommends \
    && apt-get install -y --no-install-recommends \
    apt-transport-https ca-certificates curl sudo gnupg \
    git make cmake gcc g++ \
    zsh tmux ninja-build unzip gettext software-properties-common \
    silversearcher-ag fd-find shfmt \
    && rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/* /tmp/*

# 从 builder 阶段复制 Python
COPY --from=python-builder /usr/local/bin/python3.13 /usr/local/bin/
COPY --from=python-builder /usr/local/lib/python3.13 /usr/local/lib/

# 安装 Go
RUN GO_ARCH=amd64 \
    && case "$(uname -m)" in \
        aarch64|arm64) GO_ARCH=arm64 ;; \
    esac \
    && curl -fsSL https://golang.org/dl/go${GO_VERSION}.linux-${GO_ARCH}.tar.gz -o go.tar.gz \
    && curl -fsSL https://golang.org/dl/go${GO_VERSION}.linux-${GO_ARCH}.tar.gz.sha256 -o go.tar.gz.sha256 \
    && sha256sum -c go.tar.gz.sha256 \
    && tar -C /usr/local -xzf go.tar.gz \
    && rm go.tar.gz go.tar.gz.sha256

# 安装 Node.js 24 LTS
RUN NODE_ARCH=x64 \
    && case "$(uname -m)" in \
        aarch64|arm64) NODE_ARCH=arm64 ;; \
    esac \
    && curl -fsSL https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}-linux-${NODE_ARCH}.tar.xz -o node.tar.xz \
    && curl -fsSL https://nodejs.org/dist/v${NODE_VERSION}/SHASUMS256.txt -o SHASUMS256.txt \
    && grep "node-v${NODE_VERSION}-linux-${NODE_ARCH}.tar.xz" SHASUMS256.txt | sha256sum -c - \
    && mkdir -p /usr/local/node \
    && tar -C /usr/local/node --strip-components=1 -xJf node.tar.xz \
    && rm node.tar.xz SHASUMS256.txt

# 从 builder 阶段复制 Python
COPY --from=python-builder /usr/local/bin/python3.13 /usr/local/bin/
COPY --from=python-builder /usr/local/lib/python3.13 /usr/local/lib/

# OCI Labels
LABEL org.opencontainers.image.title="devcontainer-debian" \
      org.opencontainers.image.description="Development container with Go, Python, Node.js and C++17" \
      org.opencontainers.image.version.go="${GO_VERSION}" \
      org.opencontainers.image.version.python="${PY_VERSION}" \
      org.opencontainers.image.version.node="${NODE_VERSION}"

WORKDIR /root
